<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>出荷登録画面 - 複数個体対応サンプル</title>

</head>
<body>


  <h2>出荷登録</h2>

  <%= form_with model: @shipment, url: shipments_path, local: true do |f| %>
    <div class="form-group">
        <%= f.label :customer, '顧客名' %>
        <%# ★ f.text_field を使って、name="shipment[customer]" を生成する %>
        <%= f.text_field :customer, class: 'form-control', placeholder: '顧客名を入力' %>
    </div>

    <div class="form-group">
        <%= f.label :ship_date, '出荷日' %>
        <%# ★ f.date_field を使って、name="shipment[ship_date]" を生成する %>
        <%= f.date_field :ship_date, class: 'form-control', placeholder: '出荷日を入力' %>
    </div>

    <h3>出荷アイテム</h3>
      <div class="form-group">
        <label for="barcode-scanner-input">在庫IDをスキャンまたは入力</label>
        <input type="text" id="barcode-scanner-input" class="form-control" placeholder="ここにスキャンしてください...">
      </div>
      <div id="scanned-items-list">
        <%# スキャンされたアイテムがここに追加される %>
      </div>
      <div class="form-actions">
        <%= f.submit '出荷登録', class: 'btn btn-primary' %>
      </div>

    <div class="form-actions">
      <%= f.submit "出荷登録", class: "btn-submit" %> 
    </div>
  <% end %>
</div>

<template id="shipment-group-template">
  <div class="shipment-group">
    <div class="shipment-group-header">
      <label>個体・部位の選択</label>
      <button type="button" class="btn-remove-group">この商品を削除</button>
    </div>
    
    <div class="form-group">
        <%# 以前は <select ...> だった部分 %>
        <%= label_tag :individual_selector, "識別番号" %> <%# ラベルを追加 %>
        <%= select_tag :individual_selector,
                        options_from_collection_for_select(@individuals, :id, :identification_id),
                        prompt: "識別番号を選択してください",
                        class: "form-control individual-selector" %>
        </div>
    
    <div class="form-group">
      <div class="inventory-selection-area inventory-selection-list">
        <p class="text-muted">部位を選択してください。</p>
      </div>
    </div>
  </div>
</template>


<script>
// shipments/new.html.erb の <script> タグ内、または専用JSファイル
document.addEventListener('turbo:load', () => {
  const scannerInput = document.getElementById('barcode-scanner-input');
  const itemsList = document.getElementById('scanned-items-list');

  if (!scannerInput || !itemsList) return;

  scannerInput.addEventListener('change', (event) => {
    const inventoryId = event.target.value;
    if (inventoryId.trim() === '') return;

    fetch(`/inventories/find_by_barcode?id=${inventoryId}`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
        } else {
          addScannedItemToList(data);
        }
        event.target.value = ''; // 入力欄をクリア
        event.target.focus(); // 再度フォーカス
      })
      .catch(err => {
        console.error(err);
        alert('エラーが発生しました。');
        event.target.value = '';
        event.target.focus();
      });
  });

  function addScannedItemToList(item) {
    // 既に追加されていないかチェック
    if (document.getElementById(`inventory_item_${item.id}`)) {
      alert('このアイテムは既に追加されています。');
      return;
    }

    const itemDiv = document.createElement('div');
    itemDiv.id = `inventory_item_${item.id}`;
    itemDiv.classList.add('scanned-item');
    itemDiv.innerHTML = `
      <span>${item.part} (${item.weight} kg) - ID: ${item.id}</span>
      <input type="hidden" name="shipment[inventory_ids][]" value="${item.id}">
      <button type="button" class="remove-scanned-item">&times;</button>
    `;
    itemsList.appendChild(itemDiv);
  }

  itemsList.addEventListener('click', (event) => {
    if (event.target.classList.contains('remove-scanned-item')) {
      event.target.closest('.scanned-item').remove();
    }
  });
});

</script>

</body>
</html>