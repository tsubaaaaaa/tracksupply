<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>出荷登録画面 - 複数個体対応サンプル</title>

</head>
<body>


  <h2>出荷登録</h2>

  <%= form_with model: @shipment, url: shipments_path, local: true do |f| %>
    <div class="form-group">
        <%= f.label :customer, '顧客名' %>
        <%# ★ f.text_field を使って、name="shipment[customer]" を生成する %>
        <%= f.text_field :customer, class: 'form-control', placeholder: '顧客名を入力' %>
    </div>

    <div class="form-group">
        <%= f.label :ship_date, '出荷日' %>
        <%# ★ f.date_field を使って、name="shipment[ship_date]" を生成する %>
        <%= f.date_field :ship_date, class: 'form-control', placeholder: '出荷日を入力' %>
    </div>

    <h3>出荷アイテム</h3>
      <div class="form-group">
        <label for="barcode-scanner-input">在庫IDをスキャンまたは入力</label>
        <input type="text" id="barcode-scanner-input" class="form-control" placeholder="ここにスキャンしてください...">
      </div>
      <div id="scanned-items-list">
        <%# スキャンされたアイテムがここに追加される %>
      </div>
      <div class="form-actions">
        <%= f.submit '出荷登録', class: 'btn btn-primary' %>
      </div>

    <div class="form-actions">
      <%= f.submit "出荷登録", class: "btn-submit" %> 
    </div>
  <% end %>
</div>



<script>
// shipments/new.html.erb の <script> タグ内、または専用JSファイル
document.addEventListener('turbo:load', () => {
  const scannerInput = document.getElementById('barcode-scanner-input');
  const itemsList = document.getElementById('scanned-items-list');

  if (!scannerInput || !itemsList) return;

  // ★★★ ここから修正 ★★★
  // 'change'イベントの代わりに 'keydown' イベントを監視してEnterキーを捕捉します
  scannerInput.addEventListener('keydown', (event) => {
    // 押されたキーが 'Enter' (またはキーコード13) かどうかをチェック
    if (event.key === 'Enter' || event.keyCode === 13) {
      
      // 1. Enterキーによるフォームの自動送信をキャンセル！
      event.preventDefault(); 
      
      const inventoryId = event.target.value;
      if (inventoryId.trim() === '') return;

      // 2. 在庫情報をサーバーに問い合わせる処理を直接呼び出す
      fetchInventoryData(inventoryId);
    }
  });

  // サーバーに在庫情報を問い合わせる関数
  function fetchInventoryData(id) {
    // 2. サーバーのAPIを叩いて在庫情報を問い合わせる
    fetch(`/inventories/find_by_barcode?id=${id}`)
      .then(response => {
        if (!response.ok) { // 404や500エラーもここでキャッチ
            return response.json().then(err => { throw err; });
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          // サーバーから { error: "..." } が返ってきた場合
          alert(data.error);
        } else {
          // 3. 成功したら、画面のリストにアイテムを追加
          addScannedItemToList(data);
        }
        scannerInput.value = ''; // 入力欄をクリア
        scannerInput.focus(); // 再度スキャンできるようにフォーカスを戻す
      })
      .catch(err => {
        console.error(err);
        // fetchが失敗した場合や、サーバーがエラーJSONを返した場合
        alert(err.error || 'エラーが発生しました。');
        scannerInput.value = '';
        scannerInput.focus();
      });
  }
  // ★★★ ここまで修正 ★★★

  function addScannedItemToList(item) {
    // 既に追加されていないかチェック
    if (document.getElementById(`inventory_item_${item.id}`)) {
      alert('このアイテムは既に追加されています。');
      return;
    }

    const itemDiv = document.createElement('div');
    itemDiv.id = `inventory_item_${item.id}`;
    itemDiv.classList.add('scanned-item');
    itemDiv.innerHTML = `
      <span>${item.part} (${item.weight} g) - ID: ${item.id}</span>
      <input type="hidden" name="shipment[inventory_ids][]" value="${item.id}">
      <button type="button" class="remove-scanned-item">&times;</button>
    `;
    itemsList.appendChild(itemDiv);
  }

  itemsList.addEventListener('click', (event) => {
    if (event.target.classList.contains('remove-scanned-item')) {
      event.target.closest('.scanned-item').remove();
    }
  });
});

</script>

</body>
</html>